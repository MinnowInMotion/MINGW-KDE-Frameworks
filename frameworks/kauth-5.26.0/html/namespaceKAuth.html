<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KAuth - KAuth Namespace Reference</title>

    <style type="text/css">
      .cp-doNotDisplay { display: none; }
      @media aural, braille, handheld, tty { .cp-doNotDisplay { display: inline; speak: normal; }}
      .cp-edit { text-align: right; }
      @media print, embossed { .cp-edit { display: none; }}
    </style>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <link rel="meta" href="http://www.kde.org/labels.rdf" type="application/rdf+xml" title="ICRA labels" />
    <meta name="trademark" content="KDE e.V." />
    <meta name="description" content="K Desktop Environment Homepage, KDE.org" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="robots" content="all" />
    <meta name="no-email-collection" content="http://www.unspam.com/noemailcollection" />
   
    <script type="text/javascript" src="../../../resources/3rd-party/jquery/jquery-3.1.0.min.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link rel="shortcut icon" href="../../../resources/favicon.ico" />
    <link rel="icon" href="../../../resources/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="../../../resources/3rd-party/bootstrap/css/bootstrap.min.css" />
  
    <link rel="stylesheet" type="text/css" href="doxygen.css" />
  
    <link rel="stylesheet" type="text/css" href="../../../resources/css/kapidox.css" />


  
</head>

<body>

  <ul class="cp-doNotDisplay">
    <li><a href="#cp-content" accesskey="2">Skip to content</a></li>
    <li><a href="#cp-menu" accesskey="5">Skip to link menu</a></li>
  </ul>

  <nav id="navbar" class="navbar navbar-static-top bg-primary">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">
          <img alt="Brand" id="navbar-logo" src="../../../resources/kde-white.svg"/>
        </a>
      </div>
      <p id="navbar-title" class="navbar-text">
        API Documentation 
      </p>
    </div>
  </nav>

  <nav class="navbar">
    <div class="container">
      <ol class="breadcrumb navbar-nav">
      
        <li><a href="../../../index.html">KDE API Reference</a></li>
      
        <li><a href="../../index.html">The KDE Frameworks</a></li>
      
        <li class="active"><a href="index.html">KAuth</a></li>
      
      </ol>

        <ul class="nav navbar-nav navbar-right">
          <li><a href="http://www.kde.org/">KDE Home</a></li>
          <li><a href="http://kde.org/contact/">Contact Us</a></li>
        </ul>
      </div>
    </div>
  </nav> <!-- /header -->

  <div id="body_wrapper" class="container">
    <div class="row">
      <div id="left" class="col-md-3">
        
    <div class="menu-box">
  <a name="cp-menu" />
  <div class="menu-title">
    <h2 id="cp-menu-project">Quick Links</h2>
    <a href="#cp-skip-project" class="cp-doNotDisplay">Skip menu "KAuth"</a>
  </div>
  <div class="menu-content">
  
    <ul>
    
      <li><a href="index.html">Main Page</a></li>
    
      <li><a href="namespaces.html">Namespace List</a></li>
    
      <li><a href="namespacemembers.html">Namespace Members</a></li>
    
      <li><a href="classes.html">Alphabetical List</a></li>
    
      <li><a href="annotated.html">Class List</a></li>
    
      <li><a href="hierarchy.html">Class Hierarchy</a></li>
    
      <li><a href="files.html">File List</a></li>
    
      <li><a href="pages.html">Related Pages</a></li>
    
    </ul>
  
  </div>
</div>


<div class="menu_box">
  <div class="menu-title">
    <h2>Class Picker</h2>
  </div>
  <div class="menu-content">
    <form name="guideform">
      <select class="form-control" name="guidelinks" style="width:100%;" onChange="window.location=document.guideform.guidelinks.options[document.guideform.guidelinks.selectedIndex].value">
        <option value="annotated.html">-- Choose --</option>
        
        <option value="classKAuth_1_1Action.html">KAuth::Action</option>
        
        <option value="classKAuth_1_1ActionReply.html">KAuth::ActionReply</option>
        
        <option value="classKAuth_1_1ExecuteJob.html">KAuth::ExecuteJob</option>
        
        <option value="classKAuth_1_1ObjectDecorator.html">KAuth::ObjectDecorator</option>
        
        <option value="namespaceKAuth.html">KAuth</option>
        
        <option value="namespaceKAuth_1_1HelperSupport.html">KAuth::HelperSupport</option>
        
      </select>
    </form>
  </div>
</div>



  <div class="menu-box">
  <div class="menu-title">
    <h2>About</h2>
  </div>
  <div class="menu-content">
    <p>Abstraction to system policy and authentication features</p>

    <dl>
      <dt>Maintainer</dt>
        <dd>    
      <a href="mailto:kde-devel@kde.org">The KDE Community</a>
    </dd>

  

      <dt>Supported platforms</dt>
        <dd>
      
        
            Linux, 
        
      
        
            MacOSX
        
      
         </dd>

      <dt>Community</dt>
        <dd>IRC: <a href="irc://freenode/#kde-devel">#kde-devel</a> on Freenode</dd>
        <dd>Mailing list: <a href="https://mail.kde.org/mailman/listinfo/kde-frameworks-devel">kde-frameworks-devel</a></dd>

    
      <dt>Use with <a href="https://techbase.kde.org/Development/Tutorials/CMake">CMake</a></dt>
        <dd><pre class="fragment">find_package(KF5Auth)
target_link_libraries(yourapp KF5::Auth)</pre>
        </dd>

    
    
      <dt>Use with QMake</dt>
        <dd><pre class="fragment">QT += KAuth </pre></dd>
    

      <dt>Clone</dt>
        <dd><pre class="fragment">git clone git://anongit.kde.org/kauth-5.26.0.git</pre></dd>
      <dt>Browse source</dt>
        <dd>KAuth on <a href="https://cgit.kde.org/kauth-5.26.0.git/tree">cgit.kde.org</a></dd>
    </dl>
  </div>
</div>




      </div> <!-- /left -->

      <!-- begin main content -->
      <div id="right" class="col-md-9">
        <div class="row-fluid">
          <div class="page-header">

            <form action="search.html" method="get" class="form-inline">
              <div id="search" class="input-group pull-right">
                <input type="text" id="search-input" name="query" aria-label="Search input" class="form-control" placeholder="Search for...">
                <span class="input-group-btn">
                  <button type="submit" class="btn btn-default" aria-label="Search">
                    <span class="glyphicon glyphicon-search"></span>
                  </button>
                </span>
              </div>
            </form>

            <div>
              <h1><a name="content"></a> KAuth </h1>
            </div>
          </div>
        </div>
        <div class="row-fluid content">
          <div id="main">
            



<div id="top"> <!-- Doxygen will close this div -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a> &#124;
<a href="#nested-classes">Classes</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">KAuth Namespace Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr class="memitem:namespaceKAuth_1_1HelperSupport"><td class="memItemLeft" align="right" valign="top"> &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceKAuth_1_1HelperSupport.html">HelperSupport</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classKAuth_1_1Action.html">Action</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classKAuth_1_1ActionReply.html">ActionReply</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classKAuth_1_1ExecuteJob.html">ExecuteJob</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classKAuth_1_1ObjectDecorator.html">ObjectDecorator</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a0019af4c0d5ccffdb2035bcdf0195c36"><td class="memItemLeft" align="right" valign="top"><a id="a0019af4c0d5ccffdb2035bcdf0195c36"></a>
AuthorizationRef&#160;</td><td class="memItemRight" valign="bottom"><b>authRef</b> ()</td></tr>
<tr class="separator:a0019af4c0d5ccffdb2035bcdf0195c36"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae0add06b0ef989603926c72814527370"><td class="memItemLeft" align="right" valign="top"><a id="ae0add06b0ef989603926c72814527370"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>debugMessageReceived</b> (int t, const QString &amp;message)</td></tr>
<tr class="separator:ae0add06b0ef989603926c72814527370"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1bb7a39a5d196b96ce47ccb788005bfb"><td class="memItemLeft" align="right" valign="top"><a id="a1bb7a39a5d196b96ce47ccb788005bfb"></a>
QDataStream &amp;&#160;</td><td class="memItemRight" valign="bottom"><b>operator&lt;&lt;</b> (QDataStream &amp;d, const <a class="el" href="classKAuth_1_1ActionReply.html">ActionReply</a> &amp;reply)</td></tr>
<tr class="separator:a1bb7a39a5d196b96ce47ccb788005bfb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a81b260bfb39aaa1dad34c0c731ea18c2"><td class="memItemLeft" align="right" valign="top"><a id="a81b260bfb39aaa1dad34c0c731ea18c2"></a>
QDataStream &amp;&#160;</td><td class="memItemRight" valign="bottom"><b>operator&gt;&gt;</b> (QDataStream &amp;stream, <a class="el" href="classKAuth_1_1ActionReply.html">ActionReply</a> &amp;reply)</td></tr>
<tr class="separator:a81b260bfb39aaa1dad34c0c731ea18c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a209497162f6fae009ecd8d68826b7be0"><td class="memItemLeft" align="right" valign="top"><a id="a209497162f6fae009ecd8d68826b7be0"></a>
static bool&#160;</td><td class="memItemRight" valign="bottom"><b>remote_dbg</b> = false</td></tr>
<tr class="separator:a209497162f6fae009ecd8d68826b7be0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1cf730bc1713558832b1bc140c1e9b12"><td class="memItemLeft" align="right" valign="top"><a id="a1cf730bc1713558832b1bc140c1e9b12"></a>
static AuthorizationRef&#160;</td><td class="memItemRight" valign="bottom"><b>s_authRef</b> = NULL</td></tr>
<tr class="separator:a1cf730bc1713558832b1bc140c1e9b12"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9c01e406847732814efc8f979befd41b"><td class="memItemLeft" align="right" valign="top"><a id="a9c01e406847732814efc8f979befd41b"></a>
static QHash&lt; QString, <a class="el" href="classKAuth_1_1ExecuteJob.html">ExecuteJob</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>s_watchers</b></td></tr>
<tr class="separator:a9c01e406847732814efc8f979befd41b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><h1><a class="anchor" id="kauth_intro"></a>
Introduction</h1>
<p>The KDE Authorization API allows developers to write desktop applications that run high-privileged tasks in an easy, secure and cross-platform way. Previously, if an application had to do administrative tasks, it had to be run as root, using mechanisms such as sudo or graphical equivalents, or by setting the executable's setuid bit. This approach has some drawbacks. For example, the whole application code, including GUI handling and network communication, had to be done as root. More code that runs as root means more possible security holes.</p>
<p>The solution is the caller/helper pattern. With this pattern, the privileged code is isolated in a small helper tool that runs as root. This tool includes only the few lines of code that actually need to be run with privileges, not the whole application logic. All the other parts of the application are run as a normal user, and the helper tool is called when needed, using a secure mechanism that ensures that the user is authorized to do so. This pattern is not very easy to implement, because the developer has to deal with a lot of details about how to authorize the user, how to call the helper with the right privileges, how to exchange data with the helper, etc.. This is where the new KDE Authorization API becomes useful. Thanks to this new library, every developer can implement the caller/helper pattern to write application that require high privileges, with a few lines of code in an easy, secure and cross-platform way.</p>
<p>Not only: the library can also be used to lock down some actions in your application without using a helper but just checking for authorization and verifying if the user is allowed to perform it.</p>
<p>The KDE Authorization library uses different backends depending on the system where it's built. As far as the user authorization is concerned, it currently uses PolicyKit on linux and Authorization Services on Mac OSX, and a Windows backend will eventually be written, too. At the communication layer, the library uses D-Bus on every supported platform.</p>
<h1><a class="anchor" id="kauth_concepts"></a>
Concepts</h1>
<p>There are a few concepts to understand when using the library. Much of those are carried from underlying APIs such as PolicyKit, so if you know something about them there shouldn't be problems.</p>
<p>An <em>action</em> is a single task that needs to be done by the application. You refer to an action using an action identifier, which is a string in reverse domain name syntax (to avoid duplicates). For example, if the date/time control center module needs to change the date, it would need an action like "org.kde.datatime.change". If your application has to perform more than one privileged task, you should configure more than one action. This allows system administrators to fine tune the policies that allow users to perform your actions.</p>
<p>The <em>authorization</em> is the process that is executed to decide if a user can perform an action or not. In order to execute the helper as root, the user has to be authorized. For example, on linux, che policykit backend will look at the policykit policy database to see what requirements the user has to meet in order to execute the action you requested. The policy set for that action could allow or deny that user, or could say the user has to authenticate in order to gain the authorization.</p>
<p>The <em>authentication</em> is the process that allows the system to know that the person is in front of the console is who he says to be. If an action can be allowed or not depending on the user's identity, it has to be proved by entering a password or any other identification data the system requires.</p>
<p>A typical session with the authorization API is like this:</p><ul>
<li>The user want to perform some privileged task</li>
<li>The application asks the system if the user is authorized.</li>
<li>The system asks the user to authenticate, if needed, and reply the application.</li>
<li>The application uses some system-provided mechanism to execute the helper's code as the root user. Previously, you had to set the setuid bit to do this, but we have something cool called "dbus activation" that doesn't require the setuid bit and is much more flexible.</li>
<li>The helper code, immediately after starting, checks if the caller is authorized to do what it asks. If not the helper immediately exits!</li>
<li>If the caller is authorized, the helper executes the task and exits.</li>
<li>The application receives data back from the helper.</li>
</ul>
<p>All these steps are managed by the library. Following sections will focus on how to write the helper to implement your actions and how to call the helper from the application.</p>
<h1><a class="anchor" id="kauth_helper"></a>
Writing the helper tool</h1>
<p>The first thing you need to do before writing anything is to decide what actions you need to implement. Every action needs to be identified by a string in the reverse domain name syntax. This helps to avoid duplicates. An example of action id is "org.kde.datetime.change" or "org.kde.ksysguard.killprocess". <a class="el" href="classKAuth_1_1Action.html" title="Class to access, authorize and execute actions. ">Action</a> names can only contain lowercase letters and dots (not as the first or last char). You also need an identifier for your helper. An application using the KDE auth api can implement and use more than one helper, implementing different actions. An helper is uniquely identified in the system context with a string. It, again, is in reverse domain name syntax to avoid duplicates. A common approach is to call the helper like the common prefix of your action names. For example, the Date/Time kcm module could use a helper called "org.kde.datetime", to perform actions like "org.kde.datetime.changedate" and "org.kde.datetime.changetime". This naming convention simplifies the implementation of the helper.</p>
<p>From the code point of view, the helper is implemented as a QObject subclass. Every action is implemented by a public slot. In the example/ directory in the source code tree you find a complete example. Let's look at that. The helper.h file declares the class that implements the helper. It looks like:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;kauth.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceKAuth.html">KAuth</a>;</div><div class="line"></div><div class="line"><span class="keyword">class </span>MyHelper : <span class="keyword">public</span> QObject</div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Q_SLOTS:</div><div class="line">        <a class="code" href="classKAuth_1_1ActionReply.html">ActionReply</a> read(<span class="keyword">const</span> QVariantMap&amp; args);</div><div class="line">        <a class="code" href="classKAuth_1_1ActionReply.html">ActionReply</a> write(<span class="keyword">const</span> QVariantMap&amp; args);</div><div class="line">        <a class="code" href="classKAuth_1_1ActionReply.html">ActionReply</a> longaction(<span class="keyword">const</span> QVariantMap&amp; args);</div><div class="line">};</div></div><!-- fragment --><p>The slot names are the last part of the action name, without the helper's ID if it's a prefix, with all the dots replaced by underscores. In this case, the helper ID is "org.kde.kf5auth.example", so those three slots implement the actions "org.kde.kf5auth.example.read", "org.kde.kf5auth.example.write" and "org.kde.kf5auth.example.longaction". The helper ID doesn't have to appear at the beginning of the action name, but it's good practice. If you want to extend MyHelper to implement also a different action like "org.kde.datetime.changetime", since the helper ID doesn't match you'll have to implement a slot called org_kde_datetime_changetime().</p>
<p>The slot's signature is fixed: the return type is <a class="el" href="classKAuth_1_1ActionReply.html" title="Class that encapsulates a reply coming from the helper after executing an action. ...">ActionReply</a>, a class that allows you to return results, error codes and custom data to the application when your action has finished to run. Please note that due to QMetaObject being picky about namespaces, you NEED to declare the return type as <a class="el" href="classKAuth_1_1ActionReply.html" title="Class that encapsulates a reply coming from the helper after executing an action. ...">ActionReply</a> and not <a class="el" href="classKAuth_1_1ActionReply.html" title="Class that encapsulates a reply coming from the helper after executing an action. ...">KAuth::ActionReply</a>. So the using declaration is compulsory The QVariantMap object that comes as argument contains custom data coming from the application.</p>
<p>Let's look at the read action implementation. Its purpose is to read files:</p>
<div class="fragment"><div class="line">ActionReply MyHelper::read(QVariantMap args)</div><div class="line">{</div><div class="line">    ActionReply reply;</div><div class="line">    QString filename = args[<span class="stringliteral">&quot;filename&quot;</span>].toString();</div><div class="line">    QFile file(filename);</div><div class="line">    <span class="keywordflow">if</span> (!file.open(QIODevice::ReadOnly)) {</div><div class="line">       reply = <a class="code" href="classKAuth_1_1ActionReply.html#a4d6577154e215e68fe4889484465bda2">ActionReply::HelperErrorReply</a>;</div><div class="line">       reply.<a class="code" href="classKAuth_1_1ActionReply.html#a74e7456f138e08c61468569e3bdb0085">setErrorCode</a>(file.error());</div><div class="line"></div><div class="line">       <span class="keywordflow">return</span> reply;</div><div class="line">    }</div><div class="line"></div><div class="line">    QTextStream stream(&amp;file);</div><div class="line">    QString contents;</div><div class="line">    stream &gt;&gt; contents;</div><div class="line">    reply.data()[<span class="stringliteral">&quot;contents&quot;</span>] = contents;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> reply;</div><div class="line">}</div></div><!-- fragment --><p>First, the code creates a default reply object. The default constructor creates a reply that reports success. Then it gets the filename parameter from the argument QVariantMap, that has previously been set by the application, before calling the helper. If it fails to open the file, it creates an <a class="el" href="classKAuth_1_1ActionReply.html" title="Class that encapsulates a reply coming from the helper after executing an action. ...">ActionReply</a> object that notifies that some error has happened in the helper, then set the error code to that returned by QFile and returns. If there is no error, it reads the file. The contents are put into the reply.data() object, which is another QVariantMap. It will be sent back to the application with the reply.</p>
<p>Because this class will be compiled into a standalone executable, we need a main() function and some code to initialize everything: you don't have to write it. Instead, you use the KAUTH_HELPER_MAIN() macro that will take care of everything. It's used like this:</p>
<div class="fragment"><div class="line">KAUTH_HELPER_MAIN(<span class="stringliteral">&quot;org.kde.kf5auth.example&quot;</span>, MyHelper)</div></div><!-- fragment --><p>The first parameter is the string containing the helper identifier. Please note that you need to use this same string in the application's code to tell the library which helper to call, so please stay away from typos, because we don't have any way to detect them. The second parameter is the name of the helper's class. Your helper, if complex, can be composed of a lot of source files, but the important thing is to include this macro in one at least one of them.</p>
<p>To build the helper, KDE macros provide a function named kauth_install_helper_files(). Use it in your cmake file like this:</p>
<div class="fragment"><div class="line">add_executable(&lt;helper_target&gt; your sources...)</div><div class="line">target_link_libraries(&lt;helper_target&gt; your libraries...)</div><div class="line">install(TARGETS &lt;helper_target&gt; DESTINATION ${KAUTH_HELPER_INSTALL_DIR})</div><div class="line"></div><div class="line">kauth_install_helper_files(&lt;helper_target&gt; &lt;helper_id&gt; &lt;user&gt;)</div></div><!-- fragment --><p>The first argument is the cmake target name for the helper executable, which you have to build and install separately. Make sure to INSTALL THE HELPER IN ${KAUTH_HELPER_INSTALL_DIR}, otherwise kauth_install_helper_files will not work. The second argument is the helper id. Please be sure to don't misspell it, and to not quote it. The user parameter is the user that the helper has to be run as. It usually is root, but some actions could require less strict permissions, so you should use the right user where possible (for example the user apache if you have to mess with apache settings). Note that the target created by this macro already links to libkauth and QtCore</p>
<h1><a class="anchor" id="kauth_actions"></a>
Action registration</h1>
<p>To be able to authorize the actions, they have to be added to the policy database. To do this in a cross-platform way, we provide a cmake macro. It looks like: </p><div class="fragment"><div class="line">kauth_install_actions(&lt;helper_id&gt; &lt;actions definition file&gt;)</div></div><!-- fragment --><p>The action definition file describes which actions are implemented by your code and which default security options they should have. It is a common text file in ini format, with one section for each action and some parameters. The definition for the read action is:</p>
<pre class="fragment">[org.kde.kf5auth.example.read]
Name=Read action
Description=Read action description
Policy=auth_admin
Persistence=session
</pre><p>The name parameter is a text describing the action for <em>who reads the file</em>. The description parameter is the message shown to the user in the authentication dialog. It should be a finite phrase. The policy attribute specify the default rule that the user must satisfy to be authorized. Possible values are:</p><ul>
<li>yes: the action should be always allowed</li>
<li>no: the action should be always denied</li>
<li>auth_self: the user should authenticate as itself</li>
<li>auth_admin: the user should authenticate as an administrator user</li>
</ul>
<p>The persistence attribute is optional. It says how long an authorization should be retained for that action. The values could be:</p><ul>
<li>session: the authorization persists until the user logs-out</li>
<li>always: the authorization will persist indefinitely</li>
</ul>
<h1><a class="anchor" id="kauth_app"></a>
Calling the helper from the application</h1>
<p>Once the helper is ready, we need to call it from the main application. In the example's mainwindow.cpp you can see how this is done. To create a reference to an action, an object of type <a class="el" href="classKAuth_1_1Action.html" title="Class to access, authorize and execute actions. ">Action</a> has to be created. Every <a class="el" href="classKAuth_1_1Action.html" title="Class to access, authorize and execute actions. ">Action</a> object refers to an action by its action id. Two objects with the same action id will act on the same action. With an <a class="el" href="classKAuth_1_1Action.html" title="Class to access, authorize and execute actions. ">Action</a> object, you can authorize and execute the action. To execute an action you have a couple of choices:</p><ul>
<li>A synchronous call, using the <a class="el" href="classKAuth_1_1Action.html#ac2afcc97d09158b94fa550cb67485520" title="Synchronously executes the action. ">Action::execute()</a> method, will start the helper, execute the action and return the reply.</li>
<li>An asynchronous call, by setting Action::setExecutesAsync(true) and calling <a class="el" href="classKAuth_1_1Action.html#ac2afcc97d09158b94fa550cb67485520" title="Synchronously executes the action. ">Action::execute()</a>, will start the helper and return immediately.</li>
</ul>
<p>The asynchronous call is the most flexible alternative, but you need a way to obtain the reply. This is done by connecting to a signal, but the <a class="el" href="classKAuth_1_1Action.html" title="Class to access, authorize and execute actions. ">Action</a> class is not a QObject subclass. Instead, you connect to signals exposed by the ActionWatcher class. For every action id you use, there is one ActionWatcher object. You can retrieve it using the Action::watcher() method. If you execute an action using Action::executeAsync(), you can connect to the actionPerformed(ActionReply) signal to be notified when the action has been completed (or failed). As a parameter, you'll get a reply object containing all the data you need. As a convenience, you can also pass an object and a slot to the executeAsync() method to directly connect them to the signal, if you don't want to mess with watchers.</p>
<p>The piece of code that calls the action of the previous example is located in example/mainwindow.cpp in the on_readAction_triggered() slot. It looks like this: </p><div class="fragment"><div class="line">QVariantMap args;</div><div class="line">args[<span class="stringliteral">&quot;filename&quot;</span>] = filename;</div><div class="line">Action readAction = <span class="stringliteral">&quot;org.kde.kf5auth.example.read&quot;</span>;</div><div class="line">readAction.setHelperID(<span class="stringliteral">&quot;org.kde.kf5auth.example&quot;</span>);</div><div class="line">readAction.setArguments(args);</div><div class="line"></div><div class="line">ActionReply reply = readAction.execute();</div><div class="line"><span class="keywordflow">if</span> (reply.failed())</div><div class="line">   QMessageBox::information(<span class="keyword">this</span>, <span class="stringliteral">&quot;Error&quot;</span>, QString(<span class="stringliteral">&quot;KAuth returned an error code: %1&quot;</span>).arg(reply.errorCode()));</div><div class="line"><span class="keywordflow">else</span></div><div class="line">   contents = reply.data()[<span class="stringliteral">&quot;contents&quot;</span>].toString();</div></div><!-- fragment --><p>First of all, it creates the action object specifying the action id. Then it loads the filename (we want to read a forbidden file) into the arguments() QVariantMap, which will be directly passed to the helper in the read() slot's parameter. This example code uses a synchronous call to execute the action and retrieve the reply. If the reply succeeded, the reply data is retrieved from the returned QVariantMap object. Please note that, although the execute() method will return only when the action is completed, the GUI will remain responsive because an internal event loop is entered. This means you should be prepared to receive other events in the meanwhile. Also, notice that you have to explicitly set the helper ID to the action: this is done for added safety, to prevent the caller from accidentally invoking a helper, and also because <a class="el" href="namespaceKAuth.html">KAuth</a> actions may be used without a helper attached (the default). In this case, action.execute() will return ActionSuccess if the authentication went well. This is quite useful if you want your user to authenticate before doing something, which however needs no privileged permissions implementation-wise.</p>
<h1><a class="anchor" id="kauth_async"></a>
Asynchronous calls, data reporting, and action termination</h1>
<p>For a more advanced example, we look at the action "org.kde.kf5auth.example.longaction" in the example helper. This is an action that takes a long time to execute, so we need some features:</p><ul>
<li>The helper needs to regularly send data to the application, to inform about the execution status.</li>
<li>The application needs to be able to stop the action execution if the user stops it or close the application. The example code follows: <div class="fragment"><div class="line">ActionReply MyHelper::longaction(QVariantMap args)</div><div class="line">{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= 100; i++) {</div><div class="line">       <span class="keywordflow">if</span> (<a class="code" href="namespaceKAuth_1_1HelperSupport.html#a92d5d14499774c17e5ed1bd38ab26804">HelperSupport::isStopped</a>())</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">       <a class="code" href="namespaceKAuth_1_1HelperSupport.html#a3fe5f7ed6e46213d7ffc39c4eec67f77">HelperSupport::progressStep</a>(i);</div><div class="line">       usleep(250000);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classKAuth_1_1ActionReply.html#a211040c1fd29b3575b1921c4da647225">ActionReply::SuccessReply</a>;</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
<p>In this example, the action is only waiting a "long" time using a loop, but we can see some interesting line. The progress status is sent to the application using the <a class="el" href="namespaceKAuth_1_1HelperSupport.html#a3fe5f7ed6e46213d7ffc39c4eec67f77" title="Send a progressStep signal to the caller application. ">HelperSupport::progressStep()</a> method. When this method is called, the ActionWatcher associated with this action will emit the progressStep() signal, reporting back the data to the application. There are two overloads of these methods and corresponding signals. The one used here takes an integer. Its meaning is application dependent, so you can use it as a sort of percentage. The other overload takes a QVariantMap object that is directly passed to the app. In this way, you can report to the application all the custom data you want.</p>
<p>In this example code, the loop exits when the <a class="el" href="namespaceKAuth_1_1HelperSupport.html#a92d5d14499774c17e5ed1bd38ab26804" title="Check if the caller asked the helper to stop the execution. ">HelperSupport::isStopped()</a> returns true. This happens when the application calls the stop() method on the correponding action object. The stop() method, this way, asks the helper to stop the action execution. It's up to the helper to obbey to this request, and if it does so, it should return from the slot, <em>not</em> exit.</p>
<p>The code that calls the action in the application connects a slot to the actionPerformed() signal and then call executeAsync(). The progressStep() signal is directly connected to a QProgressBar, and the Stop button in the UI is connected to a slot that calls the Action::stop() method.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MainWindow::on_longAction_triggered()</div><div class="line">{</div><div class="line">   Action longAction = <span class="stringliteral">&quot;org.kde.kf5auth.example.longaction&quot;</span>;</div><div class="line">   connect(longAction.watcher(), SIGNAL(<a class="code" href="namespaceKAuth_1_1HelperSupport.html#a3fe5f7ed6e46213d7ffc39c4eec67f77">progressStep</a>(<span class="keywordtype">int</span>)),</div><div class="line">           progressBar,          SLOT(setValue(<span class="keywordtype">int</span>)));</div><div class="line">   connect(longAction.watcher(), SIGNAL(actionPerformed(ActionReply)),</div><div class="line">           <span class="keyword">this</span>,                 SLOT(longActionPerformed(ActionReply)));</div><div class="line"></div><div class="line">   longAction.setExecutesAsync(<span class="keyword">true</span>);</div><div class="line">   <span class="keywordflow">if</span> (longAction.execute() != Action::Authorized)</div><div class="line">       this-&gt;statusBar()-&gt;showMessage(<span class="stringliteral">&quot;Could not execute the long action&quot;</span>);</div><div class="line"></div><div class="line">   <span class="comment">//...</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MainWindow::stopLongAction()</div><div class="line">{</div><div class="line">    Action(<span class="stringliteral">&quot;org.kde.kf5auth.example.longaction&quot;</span>).stop();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MainWindow::longActionPerformed(ActionReply reply)</div><div class="line">{</div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (reply.succeeded())</div><div class="line">       this-&gt;statusBar()-&gt;showMessage(<span class="stringliteral">&quot;Action succeeded&quot;</span>, 10000);</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">       this-&gt;statusBar()-&gt;showMessage(QString(<span class="stringliteral">&quot;Could not execute the long action: %1&quot;</span>).arg(reply.errorCode()), 10000);</div><div class="line">}</div></div><!-- fragment --><p>Please pay attention that when you call an action, the helper will be busy executing that action. Therefore, you can't call two execute() methods in sequence like that:</p>
<div class="fragment"><div class="line">action1.execute();</div><div class="line">action2.execute();</div></div><!-- fragment --><p>If you do, you'll get a HelperBusy reply from the second action. A solution would be to launch the second action from the slot connected to the first's actionPerformed signal, but this would be very ugly. Read further to know how to solve this problem.</p>
<h1><a class="anchor" id="kauth_other"></a>
Other features</h1>
<p>To allow to easily execute several actions in sequence, you can execute them in a group. This means using the Action::executeActions() static method, which takes a list of actions and asks the helper to execute them with a single request. The helper will execute the actions in the specified order. All the signals will be emitted from the watchers associated with each action.</p>
<p>Sometimes the application needs to know when a particular action has started to execute. For this purpose, you can connect to the actionStarted() signal. It is emitted immediately before the helper's slot is called. This isn't very useful if you call execute(), but if you use executeActions() it lets you know when individual actions in the group are started.</p>
<p>It doesn't happen very frequently that you code something that doesn't require some debugging, and you'll need some tool, even a basic one, to debug your helper code as well. For this reason, the KDE Authorization library provides a message handler for the Qt debugging system. This means that every call to qDebug() &amp; co. will be reported to the application, and printed using the same qt debugging system, with the same debug level. If, in the helper code, you write something like: </p><div class="fragment"><div class="line">qDebug() &lt;&lt; <span class="stringliteral">&quot;I&#39;m in the helper&quot;</span>;</div></div><!-- fragment --><p> You'll see something like this in the <em>application</em>'s output:</p>
<pre class="fragment">Debug message from the helper: I'm in the helper
</pre><p>Remember that the debug level is preserved, so if you use qFatal() you won't only abort the helper (which isn't suggested anyway), but also the application. </p>
</div></div><!-- contents -->

<div class="copyrights">
  This file is part of the KDE documentation.<br/>
  Documentation copyright &copy; 1996-2017 The KDE developers.<br/>
  Generated on Wed Aug 16 2017 09:22:57 by
  <a href="http://www.doxygen.org/">doxygen</a> 1.8.13 written
  by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>, &copy;&nbsp;1997-2006
  <p>
  KDE's <a href="http://community.kde.org/Policies/Library_Documentation_Policy">Doxygen guidelines</a> are available online.
  </p>
</div>


          </div>
        </div>
      </div> <!-- /right -->
    </div> <!-- /body -->
  </div> <!-- /body_wrapper -->

  <footer class="footer bg-primary">
    <div id="footer-text" class="center-block col-md-7" style="float:none;">
        <p>Report problems with this website to <a href="https://go.kde.org/u/systickets">our bug tracking system</a>.<br />
Contact the specific authors with questions and comments about the page contents.<p>
<p>KDE<sup>&#174;</sup> and <a href="/media/images/kde_gear_black.png">the K Desktop Environment<sup>&#174;</sup> logo</a> are registered trademarks of <a href="http://ev.kde.org/" title="Homepage of the KDE non-profit Organization">KDE e.V.</a> | <a href="http://www.kde.org/contact/impressum.php">Legal</a></p>
    </div>
    
  </footer>

<!--
WARNING: DO NOT SEND MAIL TO THE FOLLOWING EMAIL ADDRESS! YOU WILL
BE BLOCKED INSTANTLY AND PERMANENTLY!
<a href="mailto:aaaatrap-45abe0e0c3bebc77@kde.org">Block me</a>
WARNING END
-->

</body>
</html>